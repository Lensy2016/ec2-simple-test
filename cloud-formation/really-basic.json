{
    "AWSTemplateFormatVersion" : "2010-09-09",

    "Description" : "Simple template to create EC2 instances with Apache and Tomcat installed.",

    "Parameters" :
    {

        "KeyName" :
        {
            "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instances",
            "Type" : "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
        },

        "InstanceType" :
        {
            "Description" : "FormEngine EC2 instance type",
            "Type" : "String",
            "Default" : "t2.micro"
        }

    },

    "Mappings" :
    {
        "AWSInstanceType2Arch" :
        {
            "t2.micro"    : { "Arch" : "64" },
            "t2.small"    : { "Arch" : "64" },
            "t2.medium"   : { "Arch" : "64" },
            "t2.large"    : { "Arch" : "64" }
        },
        "AWSRegionArch2AMI" : {
            "eu-west-1"      : { "64" : "ami-d41d58a7" }
        }
    },

    "Resources" :
    {
        "WebServerGroup" :
        {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" :
            {
                "GroupDescription" : "Enable SSH and HTTP access",
                "SecurityGroupIngress" :
                [
                    { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0" },
                    { "IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0" }
                ]
            }
        },

        "WebServer":
        {
            "Type" : "AWS::EC2::Instance",
            "Metadata" :
            {
                "AWS::CloudFormation::Init":
                {
                    "config" :
                    {
                        "packages" :
                        {
                            "yum" :
                            {
                                "java-1.6.0-openjdk": [],
                                "tomcat6": [],
                                "httpd": []
                            }
                        }
                    }
                }
            },

            "Properties": {

                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSRegionArch2AMI",
                        {"Ref": "AWS::Region"},
                        {
                            "Fn::FindInMap": [
                                "AWSInstanceType2Arch",
                                {"Ref": "InstanceType"},
                                "Arch"
                            ]
                        }
                    ]
                },

                "InstanceType": {"Ref": "InstanceType"},
                "SecurityGroups": [{"Ref": "WebServerGroup"}],
                "KeyName": {"Ref": "KeyName"},
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "WebServer"
                    }
                ]

            }

        },

        "IPAddress" :
        {
            "Type" : "AWS::EC2::EIP"
        },

        "IPAssoc" :
        {
            "Type" : "AWS::EC2::EIPAssociation",
            "Properties" :
            {
                "InstanceId" : { "Ref" : "WebServer" },
                "EIP" : { "Ref" : "IPAddress" }
            }
        },

        "WaitHandle" : {
            "Type" : "AWS::CloudFormation::WaitConditionHandle"
        },

        "WaitCondition" : {
            "Type" : "AWS::CloudFormation::WaitCondition",
            "DependsOn" : "WebServer",
            "Properties" : {
                "Handle" : { "Ref" : "WaitHandle" },
                "Timeout" : "1200"
            }
        }

    },


    "Outputs" : {
        "InstanceIPAddress" : {
            "Value" : { "Ref" : "IPAddress" },
            "Description" : "public IP address of the new WebServer"
        },
        "InstanceName" : {
            "Value" : { "Fn::GetAtt" : [ "WebServer", "PublicDnsName" ]},
            "Description" : "public DNS name of the new WebServer"
        }
    }

}